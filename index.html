<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>中学理科 一問一答（ベータ）</title>
    <link rel="stylesheet" href="./assets/style.css" />
  </head>
  <body>
    <header class="container">
      <h1>中学理科 一問一答 v0.1</h1>
      <p class="muted">a</p>
    </header>

    <main class="container card">
      <h2>設定</h2>

      <div class="row">
        <label for="count">問題数</label>
        <select id="count">
          <option value="10">10問</option>
          <option value="20">20問</option>
          <option value="30">30問</option>
          <option value="50">50問</option>
          <option value="all">全問</option>
        </select>
      </div>

      <div class="row">
        <label for="unit">単元（ベータ：全て固定）</label>
        <select id="unit" disabled>
          <option value="all" selected>全て</option>
        </select>
        <small class="muted"
          >※CSVには unit を入れておくと後で範囲選択を追加できます。</small
        >
      </div>

      <div class="actions">
        <button id="goQuiz" class="primary">ブラウザで解く（Aモード）</button>
        <button id="goWorksheet">問題を作る（印刷/PDF）</button>
      </div>

      <hr />

      <div class="row">
        <div>
          <h3>注意事項と使い方・フィードバック</h3>
          <p class="muted">
            使い方がわからないときは「使い方・注意事項」<br />問題や答えの誤り・改善案は「フォームを開く」から送ってください。
          </p>
          <button class="linklike open-intro" type="button">
            使い方・注意事項
          </button>
          <br /><button class="linklike open-feedback" type="button">
            フォームを開く
          </button>
        </div>
      </div>
    </main>

    <!-- 使用上の注意/使い方（初回強制表示） -->
    <div
      id="introBackdrop"
      class="intro-backdrop hidden"
      role="dialog"
      aria-modal="true"
      aria-label="使用上の注意と使い方"
    >
      <div class="intro-modal">
        <div class="intro-head">
          <div><b>使用上の注意 / 使い方</b></div>
          <button id="introClose" class="ghost" type="button" disabled>
            閉じる
          </button>
        </div>

        <div id="introBody" class="intro-body">
          <h2>これはベータ版です</h2>
          <ul>
            <li>問題・解答に誤りが含まれる可能性があります。</li>
            <li>
              採点は「完全一致（＋別解）」中心です。表記ゆれは別解として登録して対応します。
            </li>
            <li>
              内容の正確性は、教科書・授業プリント等で最終確認してください。
            </li>
          </ul>

          <h2>フィードバックのお願い</h2>
          <ul>
            <li>誤り・改善案は「誤り/改善フォーム」から送ってください。</li>
            <li>個人情報（氏名・住所・学校名など）は送らないでください。</li>
          </ul>

          <h2>使い方</h2>
          <ol>
            <li>ホームで問題数を選びます。</li>
            <li>「ブラウザで解く（Aモード）」を押します。</li>
            <li>表示された問題すべてに答えを入力します。</li>
            <li>「一気に採点」で○×と正答が表示されます。</li>
            <li>間違いだけ再挑戦もできます。</li>
          </ol>

          <h2>印刷/PDF</h2>
          <ul>
            <li>
              ホームから「問題を作る（印刷/PDF）」を選ぶと、A/B形式で問題を出力できます。
            </li>
            <li>「印刷」からPDF保存もできます。</li>
          </ul>

          <hr />
          <p class="muted">
            下までスクロールすると「同意して開始」が押せます。
          </p>
          <div style="height: 40px"></div>
        </div>

        <div class="intro-foot">
          <div id="introHint" class="intro-hint">
            下までスクロールしてください
          </div>
          <div class="actions" style="margin: 0">
            <button id="introAccept" class="primary" type="button" disabled>
              同意して開始
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- フォーム埋め込みモーダル -->
    <div
      id="fbBackdrop"
      class="fb-backdrop hidden"
      role="dialog"
      aria-modal="true"
      aria-label="フィードバックフォーム"
    >
      <div class="fb-modal">
        <div class="fb-head">
          <div><b>誤り報告・改善フォーム</b></div>
          <button id="fbClose" class="ghost" type="button">閉じる</button>
        </div>
        <iframe id="fbFrame" title="Google Form" loading="lazy"></iframe>
      </div>
    </div>

    <footer class="container footer">
      <span class="muted">v0.1</span>
    </footer>

    <script type="module">
      import {
        saveSettings,
        loadSettings,
        initFeedbackModal,
        initIntroModal,
      } from "./assets/app.js";

      // ★ここを quiz.js と同じ埋め込みURLに
      const FEEDBACK_EMBED_URL =
        "https://docs.google.com/forms/d/e/1FAIpQLSfUVun_xGMb8m2UGkkEBVzQe3iBfJY8bk6yUUIiLvsTdh2EpQ/viewform?usp=dialog_embedded=true";
      initFeedbackModal(FEEDBACK_EMBED_URL);

      // ★使用上の注意：初回だけ強制表示（バージョン変えたければキーを変える）
      initIntroModal({
        storageKey: "jhs_intro_seen_v1",
        forceOpenOnFirstVisit: true,
      });

      const countEl = document.getElementById("count");
      const unitEl = document.getElementById("unit");

      const settings = loadSettings();
      if (settings.count) countEl.value = settings.count;
      if (settings.unit) unitEl.value = settings.unit;

      function commit() {
        saveSettings({
          count: countEl.value,
          unit: unitEl.value,
          source: "teacher",
        });
      }

      document.getElementById("goQuiz").addEventListener("click", () => {
        commit();
        location.href = "./quiz.html";
      });

      document.getElementById("goWorksheet").addEventListener("click", () => {
        commit();
        location.href = "./worksheet.html";
      });

      countEl.addEventListener("change", commit);
    </script>
  </body>
</html>
